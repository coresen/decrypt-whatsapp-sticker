<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp è´´å›¾è§£å¯† Demo</title>
    <style>
        #animationContainer {
            width: 300px;
            height: 300px;
            border: 1px solid #ddd;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <h2>è§£å¯†å¹¶ä¸‹è½½ WhatsApp è´´å›¾</h2>
    <form id="myForm">
        <div style="display: flex; flex-direction: column; margin-bottom: 20px;">
            <div >
                <label style="width: 100px; display: inline-block" for="url">ä¸‹è½½URLï¼š</label>
                <input type="text" id="url" name="url" />
            </div>

            <div>
                <label style="width: 100px; display: inline-block" for="mediaKey">mediaKeyï¼š</label>
                <input type="text" id="mediaKey" name="mediaKey" />
            </div>

            <div>
                <label style="width: 100px; display: inline-block" for="encFileHash">encFileHashï¼š</label>
                <input type="text" id="encFileHash" name="encFileHash" />
            </div>

            <div>
                <label style="width: 100px; display: inline-block" for="mimeType">mimeTypeï¼š</label>
                <input type="text" id="mimeType" name="mimeType" />
            </div>

        </div>

        <button type="submit">ä¸‹è½½è´´å›¾</button>
    </form>

    
    <img id="sticker" alt="WhatsApp Sticker" style="max-width: 300px; border: 1px solid #ddd; display: none;">
    <div id="animationContainer" style="display: none;"></div>


    <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.0/umd/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <script>
        const mediaHMACLength = 10;  // HMAC é•¿åº¦
        const appInfo = "WhatsApp Image Keys";
        // ğŸ“Œ è§£å¯†è´´å›¾å¹¶ä¿å­˜ä¸º WebP æ–‡ä»¶
        async function decryptSticker(encUrl, mediaKey, mimeType, checksumBase64) {
            try {
                // 1ï¸âƒ£ ä¸‹è½½ .enc è´´å›¾
                const response = await fetch(encUrl,{
                    method: "GET",
                    headers: {
                        "Referer": "https://web.whatsapp.com/"
                    }
                });
                const encData = new Uint8Array(await response.arrayBuffer());

                // å¦‚æœæ•°æ®å¤ªçŸ­ï¼Œåˆ™è¿”å›é”™è¯¯
                if (encData.length <= mediaHMACLength) {
                    throw new Error("File is too short");
                }

                // 2ï¸âƒ£ åˆ†å‰²æ–‡ä»¶æ•°æ®å’Œ HMAC æ•°æ®
                const file = encData.slice(0, encData.length - mediaHMACLength);  // æ–‡ä»¶æ•°æ®
                const mac = encData.slice(encData.length - mediaHMACLength);  // HMAC æ•°æ®
 
                // 3ï¸âƒ£ æ ¡éªŒ SHA256
                const hashBuffer = await crypto.subtle.digest("SHA-256", encData);
                const hashArray = new Uint8Array(hashBuffer);
                const checksum = new Uint8Array(atob(checksumBase64).split("").map(c => c.charCodeAt(0)));  // è½¬ä¸º Uint8Array
                if (!compareUint8Arrays(hashArray, checksum)) {
                    throw new Error("Invalid media file SHA256 checksum");
                }

                
                // 4ï¸âƒ£ è®¡ç®— AES-CBC è§£å¯†å¯†é’¥
                const { cipherKey, iv } = await deriveKeys(mediaKey);

                // 5ï¸âƒ£ ä½¿ç”¨ AES-CBC è§£å¯†
                const decryptedData = await decryptAESCBC(file, cipherKey, iv);

                if (mimeType=="image/webp") {
                    const blob = new Blob([decryptedData], { type: "image/webp" });
                    const stickerUrl = URL.createObjectURL(blob);

                    document.getElementById("sticker").src = stickerUrl;
                    document.getElementById("sticker").style.display = "block";
                    document.getElementById("animationContainer").style.display = "none";
                } else if (mimeType=="application/was") {
                    const unzipped = fflate.unzipSync(decryptedData);

                    var G = function(a) {
                        var b = /animation\/animation.json$/; // åªåŒ¹é… animation/animation.json
                        var c = Object.keys(a).find(function(key) {
                            return b.test(key);
                        });
                        return c != null ? a[c] : void 0; // å¦‚æœæ‰¾åˆ°ï¼Œè¿”å›å¯¹åº”çš„å€¼ï¼Œå¦åˆ™è¿”å› undefined
                    };

                    const animationJsonUint8Array = G(unzipped);
                    const animationJsonText = new TextDecoder("utf-8").decode(animationJsonUint8Array);
                    const animationJson = JSON.parse(animationJsonText);
       
                    lottie.loadAnimation({
                        container: document.getElementById('animationContainer'), // åŠ¨ç”»å®¹å™¨
                        renderer: 'svg', // æ”¯æŒ 'svg', 'canvas', 'html'
                        loop: true, // æ˜¯å¦å¾ªç¯æ’­æ”¾
                        autoplay: true, // æ˜¯å¦è‡ªåŠ¨æ’­æ”¾
                        animationData: animationJson // ä¼ å…¥ JSON åŠ¨ç”»æ•°æ®
                    });
                    document.getElementById("sticker").style.display = "none";
                    document.getElementById("animationContainer").style.display = "block";
                }
                


            } catch (error) {
                console.error("Error decrypting sticker:", error);
            }
        }

        // æ¯”è¾ƒä¸¤ä¸ª Uint8Array æ˜¯å¦ç›¸ç­‰
        function compareUint8Arrays(arr1, arr2) {
            if (arr1.length !== arr2.length) {
                return false;
            }
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] !== arr2[i]) {
                    return false;
                }
            }
            return true;
        }

        // ç”¨äº AES-CBC è§£å¯†
        async function decryptAESCBC(encData, cipherKey, iv) {
            try {
                // ä½¿ç”¨ Web Crypto API å¯¼å…¥å¯†é’¥
                const cipher = await crypto.subtle.importKey(
                    "raw", 
                    cipherKey, 
                    { name: "AES-CBC" },  // ä½¿ç”¨ AES-CBC æ¨¡å¼
                    false, 
                    ["decrypt"]
                );
               const decrypted = await crypto.subtle.decrypt(
                    { name: "AES-CBC", iv: iv }, 
                    cipher, 
                    encData
                );

                const decryptedArray = new Uint8Array(decrypted);

                return decryptedArray;
            } catch (error) {
                console.error("Decryption failed:", error);
            }
        }

        async function deriveKeys(mediaKeyBase64) {
            const mediaKey = Uint8Array.from(atob(mediaKeyBase64), c => c.charCodeAt(0));
            const salt = new TextEncoder().encode(appInfo);  // å°†åº”ç”¨ä¿¡æ¯è½¬ä¸º Uint8Array

            // ä½¿ç”¨ Web Crypto API è¿›è¡Œ HKDF æ´¾ç”Ÿ
            const hkdf = await crypto.subtle.importKey(
                "raw", 
                mediaKey, 
                { name: "HKDF" }, 
                false, 
                ["deriveBits"]
            );
            
            // æ´¾ç”Ÿ 112 å­—èŠ‚ï¼ˆæ ¹æ® Go çš„å®ç°ï¼‰
            const derivedBits = await crypto.subtle.deriveBits(
                { name: "HKDF", hash: "SHA-256", salt: new Uint8Array([]), info: salt }, 
                hkdf, 
                112 * 8  // 112 å­—èŠ‚ * 8 ä½ = 896 ä½
            );
            
            const derivedKey = new Uint8Array(derivedBits);
            const iv = derivedKey.slice(0, 16);
            const cipherKey = derivedKey.slice(16, 48);

            return { iv, cipherKey };
        }


        document.getElementById("myForm").addEventListener("submit", async function(event) {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤

            const formData = new FormData(this); // è·å–è¡¨å•æ•°æ®
            mimeType = formData.get("mimeType")
            const encUrl = formData.get("url")
            const mediaKey = formData.get("mediaKey")
            checksumBase64 = formData.get("encFileHash")

            decryptSticker(encUrl, mediaKey, mimeType, checksumBase64)
        });

    </script>
</body>
</html>
